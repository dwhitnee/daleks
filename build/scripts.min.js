var Daleks=Daleks||{};Daleks.Piece=function(){function e(a,b){b=b||{};this.pos={x:0,y:0};this.size=b.size||16;this.offset=b.offset||0;this.frameCount=b.frameCount||8;this.isAnimating=!1;this.el=$('<div class="piece '+a+'"/>')}e.prototype={getEl:function(){return this.el},setPosition:function(a){this.pos.x=a.x;this.pos.y=a.y},getScaledCenterPos:function(){var a=this.getScaledPos(this.pos);a.x+=this.size/2;a.y+=this.size/2;return a},getScaledPos:function(a){return{x:a.x*this.size,y:a.y*this.size}},finishAnimation:function(){this.isAnimating=
!1},animateTo:function(a){this.isAnimating=!0;var b=this.getScaledPos(this.pos);a=this.getScaledPos(a);var c=a.x-b.x,d=a.y-b.y,f=this,g=1,e=function(){f.drawAt({x:b.x+c/f.frameCount*g,y:b.y+d/f.frameCount*g});++g<=f.frameCount?setTimeout(e,50):f.finishAnimation()};e.call()},draw:function(){this.drawAt(this.getScaledPos(this.pos))},drawAt:function(a){this.el.css("left",a.x-this.offset);this.el.css("bottom",a.y-this.offset)},moveTowards:function(a){var b={x:this.pos.x,y:this.pos.y};this.pos.x>a.pos.x&&
b.x--;this.pos.x<a.pos.x&&b.x++;this.pos.y>a.pos.y&&b.y--;this.pos.y<a.pos.y&&b.y++;this.slideTo(b)},slideTo:function(a){this.animateTo(a);this.setPosition(a)},collidedWith:function(a){return this!=a&&this.pos.x===a.pos.x&&this.pos.y===a.pos.y},hide:function(){this.getEl().css("display","none")},show:function(){this.getEl().css("display","inherit")}};return e}();Daleks.Board=function(){function e(a,c){this.width=a||30;this.height=c||20;this.el=$('<div class="board"/>')}function a(a){return Math.floor(Math.random()*a)}e.prototype={getEl:function(){return this.el},place:function(a){a.draw();this.getEl().append(a.getEl())},placeDalek:function(b,c){do var d={x:a(this.width),y:a(this.height)};while(!this.dalekPositionIsLegal(d,c));b.setPosition(d);this.place(b)},dalekPositionIsLegal:function(a,c){return a.x!==c.pos.x&&a.y!==c.pos.y},placeDoctor:function(b){b.setPosition({x:a(this.width),
y:a(this.height)});this.place(b)},placeRubble:function(a,c){a.setPosition(c);this.place(a)},clear:function(){this.getEl().empty()},remove:function(a){a.getEl().remove()}};return e}();Daleks.GameData=function(e,a){function b(){}function c(){var b=e.getItem("highScore");return b?a.parse(b):{}}b.prototype={setHighScore:function(b){if(b>this.getHighScore()){var f=c();f.score=b;e.setItem("highScore",a.stringify(f))}},getHighScore:function(){return c().score||0}};return b}(window.localStorage,window.JSON);Daleks.DoctorControls=function(){function e(a,c){this.dirs="n ne e se s sw w nw x".split(" ");this.arrows=[];this.arrowTouchAreas=[];for(var d=0;d<this.dirs.length;d++){var f=new Daleks.Piece("arrow "+this.dirs[d]);this.arrows.push(f);this.add(f,f,a,this.dirs[d],c);if("x"!=this.dirs[d]){var e=new Daleks.Piece("arrowTouch",{offset:16});this.arrowTouchAreas.push(e);this.add(e,f,a,this.dirs[d],c)}}}function a(a,c){var d={x:a.x,y:a.y};c.match("n")&&(d.y+=1);c.match("e")&&(d.x+=1);c.match("s")&&--d.y;
c.match("w")&&--d.x;return d}e.prototype={add:function(a,c,d,f,e){a.dir=f;d.place(a);a.getEl().on("click",{dir:a.dir},function(a){e.fn.call(e.scope,a.data.dir)});a.getEl().on("mouseenter mouseleave",{arrow:c},function(a){a.data.arrow.getEl().toggleClass("highlight");return!1})},disable:function(){for(var a=0;a<this.arrows.length;a++)this.arrows[a].getEl().hide(),this.arrowTouchAreas[a]&&this.arrowTouchAreas[a].getEl().hide()},moveDoctor:function(b,c){this.disable();b.slideTo(a(b.pos,c))},update:function(a,
c,d){for(var e=0;e<this.arrows.length;e++){var g=this.arrowTouchAreas[e];this.updateControl(this.arrows[e],a,c,d);g&&this.updateControl(g,a,c,d,!0)}},updateControl:function(b,c,d,e,g){c=a(c.pos,b.dir);g&&(c=a(c,b.dir),c=a(c,b.dir),c=a(c,b.dir));g=c.x;var h=c.y;b.setPosition(c);c=!0;if(g>=d.width||0>g||h>=d.height||0>h)c=!1;else for(var k in e)if(g==e[k].pos.x&&h==e[k].pos.y){c=!1;break}c?(b.draw(),b.show()):b.hide()},draw:function(){for(var a=0;a<this.arrows.length;a++)this.arrows[a].draw(),this.arrowTouchAreas[a].draw()}};
return e}();Daleks.Animation=Daleks.Animation||{};
Daleks.Animation.SonicPulse=function(){function e(a){a=a||{};this.container=a.container;this.reverse=a.reverse;this.callback=a.callback||{};this.pos={};this.setPosition(a.epicenter);this.innerDiameter=a.innerDiameter||16;this.outerDiameter=a.outerDiameter||48;this.numCircles=5;this.drawInterval=50;this.circle=[];this.el=$('<div class="sonicPulse"/>');this.el.css("width",this.outerDiameter);this.el.css("height",this.outerDiameter);a=(this.outerDiameter-this.innerDiameter)/(this.numCircles-1);for(var b=
0;b<this.numCircles;b++){var c=this.innerDiameter+b*a,d=$('<div class="pulse">');d.css("width",c);d.css("height",c);d.css("left",(this.outerDiameter-c)/2);d.css("top",(this.outerDiameter-c)/2);this.circle[b]=d;this.el.append(d)}}e.prototype={getEl:function(){return this.el},setPosition:function(a){this.pos.x=a.x;this.pos.y=a.y},draw:function(){this.el.css("left",this.pos.x-this.outerDiameter/2-1);this.el.css("bottom",this.pos.y-this.outerDiameter/2+1)},inward:function(){},outward:function(){},animateNextFrame:function(){this.fadingInMode?
this.circle[this.current].show():this.circle[this.current].hide();this.reverse?this.current--:this.current++;if(this.current>=this.numCircles||0>=this.current)if(this.fadingInMode)this.fadingInMode=!this.fadingInMode,this.resetToFirstCircle();else{this.end();return}var a=this;setTimeout(function(){a.animateNextFrame()},this.drawInterval)},resetToFirstCircle:function(){this.current=this.reverse?this.numCircles-1:0},start:function(){this.container.append(this.el);this.draw();this.resetToFirstCircle();
this.fadingInMode=!0;this.animateNextFrame()},end:function(){this.el.remove();this.callback.success&&this.callback.success.call(this.callback.context,this.callback.args)},_doSomethingQuasiPrivate:function(){return!0}};return e}();Daleks.GameController=function(){function e(a){var b=this;this.board=new Daleks.Board(30,20);this.gameData=new Daleks.GameData;a.append(this.board.getEl());this.resetGame();this.panicButton=$(".button[data-name=abort]");this.panicButton.on("click",function(a){a.preventDefault();b.restoreControls();return!1});$(".arena").on("click",function(){$(".instructions").addClass("fadeOut")})}e.prototype={startNextLevel:function(){this.level++;this.screwdriversLeft=1;this.roundOver=!1;this.board.clear();this.isAnimating=
!1;$(".gameover").hide();$(".loading").hide();$("#highScore").text(this.gameData.getHighScore());this.doctor=new Daleks.Piece("doctor",{frameCount:4});this.controls=new Daleks.DoctorControls(this.board,{fn:this.handleMove,scope:this});this.restoreControls();this.board.placeDoctor(this.doctor);this.rubble=[];this.daleks=[];for(var a=0;a<5*this.level;a++)this.daleks[a]=new Daleks.Piece("dalek"),this.board.placeDalek(this.daleks[a],this.doctor);this.draw()},handleMove:function(a){this.controls.moveDoctor(this.doctor,
a);this.updateWorld()},draw:function(){for(var a in this.rubble)this.rubble[a].draw();this.updateControls();$("#level").text(this.level);$("#score").text(this.score)},enableControls:function(){this.disableControls();var a=this;$(".button").removeClass("disabled");$("body").on("keydown",function(b){switch(b.which){case 76:a.lastStand();break;case 83:a.sonicScrewDriver();break;case 84:a.teleport()}});$(".actions").on("click","a",function(b){b.preventDefault();b=$(b.target).closest("a").data("name");
a[b]&&a[b].call(a);return!1});this.updateScrewDriver()},disableControls:function(){this.controls.disable();$("body").off("keydown");$(".actions").off("click","a");$(".button").addClass("disabled")},updateControls:function(){this.isLastStand||this.controls.update(this.doctor,this.board,this.daleks.concat(this.rubble))},animationInProgress:function(){for(var a in this.daleks)if(this.daleks[a].isAnimating)return!0;return this.doctor.isAnimating||this.isAnimating},updateWorld:function(){var a=this,b=
function(){a.updateWorld()};this.animationInProgress()?setTimeout(b,100):(this.moveDaleks(),this.checkWorld())},checkWorld:function(){var a=this,b=function(){a.checkWorld()};if(this.animationInProgress())setTimeout(b,100);else{this.checkCollisions();this.roundOver||this.draw();var b=!0,c;for(c in this.daleks)if(this.daleks[c]){b=!1;break}b&&this.winRound();!this.roundOver&&this.isLastStand&&this.updateWorld()}},moveDaleks:function(){for(var a in this.daleks)this.daleks[a].moveTowards(this.doctor)},
dalekCollidedWithLandscape:function(a){if(a.collidedWith(this.doctor))return this.loseGame(),!1;for(var b in this.rubble)if(a.collidedWith(this.rubble[b]))return!0;return!1},checkCollisions:function(){for(var a in this.daleks)if(this.dalekCollidedWithLandscape(this.daleks[a]))this.removeDalek(a);else for(var b in this.daleks)if(this.daleks[a].collidedWith(this.daleks[b])){var c=new Daleks.Piece("rubble");this.rubble[this.rubble.length]=c;this.board.placeRubble(c,this.daleks[a].pos);this.removeDalek(a);
this.removeDalek(b);break}},removeDalek:function(a){this.board.remove(this.daleks[a]);delete this.daleks[a];this.updateScore(1)},updateScore:function(a){this.score+=a;$("#score").text(this.score)},teleport:function(){this.isAnimating=!0;this.disableControls();var a=this.doctor.getScaledCenterPos();this.board.remove(this.doctor);(new Daleks.Animation.SonicPulse({container:this.board.getEl(),epicenter:a,innerDiameter:48,outerDiameter:480,callback:{success:this.teleportReappear,context:this}})).start()},
teleportReappear:function(){this.board.placeDoctor(this.doctor);var a=this.doctor.getScaledCenterPos();(new Daleks.Animation.SonicPulse({container:this.board.getEl(),epicenter:a,innerDiameter:48,outerDiameter:480,reverse:!0,callback:{success:function(){this.doneAnimating();this.enableControls();this.updateWorld()},context:this}})).start()},doneAnimating:function(){this.isAnimating=!1},lastStand:function(){this.isLastStand=!0;this.controls.disable();this.disableControls();$(".button").addClass("disabled");
this.panicButton.removeClass("disabled hidden");this.updateWorld()},restoreControls:function(){this.isLastStand=!1;this.enableControls();this.panicButton.addClass("hidden")},updateScrewDriver:function(){0>=this.screwdriversLeft&&$(".button[data-name=sonicScrewDriver]").addClass("disabled")},sonicScrewDriver:function(){if(!(0>=this.screwdriversLeft)){this.screwdriversLeft--;this.updateScrewDriver();var a=this.doctor.pos.x,b=this.doctor.pos.y,c=this.doctor.getScaledCenterPos();(new Daleks.Animation.SonicPulse({container:this.board.getEl(),
epicenter:c,innerDiameter:16,outerDiameter:48})).start();for(var d in this.daleks)c=this.daleks[d].pos,c.x!==a&&c.x!==a+1&&c.x!==a-1||c.y!==b&&c.y!==b+1&&c.y!==b-1||this.removeDalek(d);this.updateWorld()}},winRound:function(){this.endRound();$(".victory").show();var a=this;$(".arena").one("click",function(){a.startNextLevel();return!1})},loseGame:function(){this.endRound();this.doctor.getEl().addClass("dead");$(".loser").show();this.gameData.setHighScore(this.score);$("#highScore").text(this.gameData.getHighScore());
$("#highScores").show();var a=this;$(".arena").one("click",function(){a.resetGame();a.startNextLevel();return!1})},endRound:function(){this.roundOver=!0;this.restoreControls();this.disableControls()},resetGame:function(){this.level=this.score=0}};return e}();$(document).ready(function(){(new Daleks.GameController($(".arena"))).startNextLevel()});
